<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
    <script src="../three.js/build/three.min.js"></script>
	<script src="../three.js/examples/js/Detector.js"></script>
	<script src="../three.js/examples/js/libs/stats.min.js"></script>
	<script src="../three.js/examples/js/controls/OrbitControls.js"></script>	
	<script src="../three.js/examples/js/loaders/OBJLoader.js"></script>
	<script src='../three.js/examples/js/libs/dat.gui.min.js'></script>
	<script src="js/Atlas.js"></script>
	<script src="js/Particles.js"></script>
	<script src="js/ParticleSystem.js"></script>
	<script src="js/ParticleSystemFrameset.js"></script>
	<script src="js/ParticleModifiers.js"></script>
	<script src="js/ParticleSystemUtil.js"></script>

    <link rel="stylesheet" href="css/main.css" type="text/css" media="screen" />
    <title>Three.js Particle System</title>
</head>
<body>

<div id="renderingContainer" style="position: absolute; left:0px; top:0px"></div>

<script>

	var ParticleSystemIDs = Object.freeze(
	{
		Smoke1: 1,
		Smoke2: 2,
		Flame: 3,
		FlameEmbers: 4
	});

	var ParticleEnvironmentIDs = Object.freeze(
	{
		Campfire: 1
	});

	var rendererContainer;
	var screenWidth, screenHeight;
	var pointLight, ambientLight;
	var particleSystems, loadingManager;
	var scene, camera, renderer, controls, stats, clock;
	var currentEnvironmentID;
	var smokeActive, smokeType;

	$( document ).ready( function() {

		init();		

	});

	function init() {

		clock = new THREE.Clock();		

		getScreenDimensions();
		
		initRenderer();
		initScene();
		initControls();		
		initStats();		
		initGUI();
		initListeners();

		initLights();
		ParticleSystemUtil.initializeLoadingManager();
		initSceneGeometry( function() {

			initParticleSystems();
			startParticleSystemEnvironment ( ParticleEnvironmentIDs.Campfire );
			animate();
			
		});		

	}

	function initParticleSystems() {

		particleSystems = {};
		initializeFlameSystem();	
		initializeSmokeSystem();	

	}

	function initializeSmokeSystem() {

		smokeType = ParticleSystemIDs.Smoke1;

		var smoke1Atlas = new Atlas( THREE.ImageUtils.loadTexture( 'images/smokeparticle.png' ), true );
		var smoke2Atlas = Atlas.createGridAtlas( THREE.ImageUtils.loadTexture( 'images/smokeparticles.png' ), 0.0, 1.0, 1.0, 0.0, 4.0, 4.0, false, true );

		var altVertexShader = [

			"attribute vec4 customColor;",
			"attribute vec3 customNormal;",
			"varying vec2 vUV;",
			"varying vec4 vColor;",
			"varying vec4 vPosition;", 

			"void main()",
			"{",
				"vColor = customColor;",	
				"vUV = uv;",
				"vPosition = modelViewMatrix * vec4( position, 1.0 );",
				"gl_Position = projectionMatrix * vPosition;",
			"}"

		].join("\n");

		var altFragmentShader = [

			"varying vec2 vUV;",
			"varying vec4 vColor;", 
			"varying vec4 vPosition;", 
			"uniform sampler2D texture;",

			THREE.ShaderChunk[ "common" ],

			"uniform vec3 pointLightColor[MAX_POINT_LIGHTS];",
			"uniform vec3 pointLightPosition[MAX_POINT_LIGHTS];",
			"uniform float pointLightDistance[MAX_POINT_LIGHTS];",
			"uniform float pointLightDecay[MAX_POINT_LIGHTS];",

			"void main()", 
			"{", 

				"vec4 textureColor = texture2D( texture, vUV );",
				"vec4 viewPosition = -vPosition;",
				"vec3 outgoingLight = vec3( 0.0 );",
				"vec4 diffuseColor = vColor * textureColor;",
				
				"vec3 totalDiffuseLight = vec3( 0.0 );",

				"#if MAX_POINT_LIGHTS > 0",
					"for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {",
						"vec3 lightColor = pointLightColor[ i ];",
						"vec3 lightPosition = pointLightPosition[ i ];",
						"vec3 lVector = lightPosition + viewPosition.xyz;",
						"vec3 lightDir = normalize( lVector );",
						"float attenuation = calcLightAttenuation( length( lVector ), pointLightDistance[ i ], pointLightDecay[ i ] );",
						"totalDiffuseLight += lightColor * attenuation;",
					"}",
				"#endif",

				"gl_FragColor = diffuseColor * vec4( totalDiffuseLight, 1.0 );",    
			"}"

		].join("\n");

		var customUniforms1 = THREE.UniformsUtils.merge([ THREE.UniformsLib['lights'] ]);
		customUniforms1.texture = { type: "t", value: smoke1Atlas.getTexture() };
		var altMaterial1 = new THREE.ShaderMaterial( 
		{
			uniforms: customUniforms1,

			vertexShader:   altVertexShader,
			fragmentShader: altFragmentShader,
			lights: true,

			transparent: true,  
			alphaTest: 0.5, 

			blending: THREE.CustomBlending, 
			blendSrc: THREE.SrcAlphaFactor,
			blendDst: THREE.OneMinusSrcAlphaFactor,
			blendEquation: THREE.AddEquation,

			depthTest: true,
			depthWrite: false
		});

		var customUniforms2 = THREE.UniformsUtils.merge([ THREE.UniformsLib['lights'] ]);
		customUniforms2.texture = { type: "t", value: smoke2Atlas.getTexture() };
		var altMaterial2 = altMaterial1.clone();
		altMaterial2.uniforms = customUniforms2;

		var particleSystemParams1 = {

			altMaterial: altMaterial1,

			zSort: true,

			particleAtlas : smoke1Atlas,

			atlasFrameSet: new Particles.FrameSet( [0, 4], [0, 0], true ),			
			sizeFrameSet : new Particles.FrameSet( [0, 4], [ new THREE.Vector2( 10, 10 ), new THREE.Vector2( 50, 50 ) ], false ),
			alphaFrameSet : new Particles.FrameSet( [0, 1.0, 4], [0.0, 0.1, 0.0], true ),
			colorFrameSet : new Particles.FrameSet( [0.0, 1.5, 4], [ new THREE.Vector3( 0.1, 0.1, 0.1 ), new THREE.Vector3( 0.35, 0.35, 0.35 ), new THREE.Vector3( 0.7, 0.7, 0.7 ) ], false ),

			particleReleaseRate : 150,
			particleLifeSpan : 4.0,		
			lifespan : 0

		};

		var particleSystemParams2 = {

			altMaterial: altMaterial2,

			zSort: true,

			particleAtlas : smoke2Atlas,

			atlasFrameSet: new Particles.FrameSet( [0, 4], [0, 15], true ),		
			sizeFrameSet : new Particles.FrameSet( [0, 4], [ new THREE.Vector2( 10, 10 ), new THREE.Vector2( 50, 50 ) ], false ),
			alphaFrameSet : new Particles.FrameSet( [0, 1.0, 4], [0.0, 0.1, 0.0], true ),
			colorFrameSet : new Particles.FrameSet( [0.0, 1.5, 4], [ new THREE.Vector3( 0.1, 0.1, 0.1 ), new THREE.Vector3( 0.35, 0.35, 0.35 ), new THREE.Vector3( 0.7, 0.7, 0.7 ) ], false ),

			particleReleaseRate : 150,
			particleLifeSpan : 4.0,		
			lifespan : 0

		};

		var particleSystem1 = new Particles.ParticleSystem();
		particleSystem1.initialize( camera, particleSystemParams1 );	

		var particleSystem2 = new Particles.ParticleSystem();
		particleSystem2.initialize( camera, particleSystemParams2 );	

		var positionModifier =  new Particles.RandomModifier( 
		{ 
			isScalar: false, 
			offset: new THREE.Vector3( 0, 0, 0 ), 
			range: new THREE.Vector3( 10, 0, 10 ), 
			rangeEdgeClamp: false, 
			rangeType: Particles.RangeType.Sphere, 
			runOnce: true
		} );

		var velocityModifier = new Particles.RandomModifier( 
		{ 
			isScalar: false, 
			offset: new THREE.Vector3( 0, 75, 0 ), 
			range: new THREE.Vector3( 25, 25, 25 ), 
			rangeEdgeClamp: false, 
			rangeType: Particles.RangeType.Sphere, 
			runOnce: true
		} );

		var accelerationModifier = new Particles.RandomModifier( 
		{ 
			isScalar: false, 
			offset: new THREE.Vector3( 0, -10, 0 ), 
			range: new THREE.Vector3( 0, 0, 0 ), 
			rangeEdgeClamp: false, 
			rangeType: Particles.RangeType.Cube, 
			runOnce: true
		} );

		var rotationModifier = new Particles.RandomModifier( 
		{ 
			isScalar: true, 
			offset: 0, 
			range: 360, 
			runOnce: true
		} );

		var rotationalSpeedModifier = new Particles.RandomModifier( 
		{ 
			isScalar: true, 
			offset: 50, 
			range: 400, 
			runOnce: true
		} );

		particleSystem1.bindModifier( 'position', positionModifier );
		particleSystem1.bindModifier( 'velocity', velocityModifier );
		particleSystem1.bindModifier( 'acceleration', accelerationModifier );
		particleSystem1.bindModifier( 'rotation', rotationModifier );
		particleSystem1.bindModifier( 'rotationalSpeed', rotationalSpeedModifier );

		particleSystem2.bindModifier( 'position', positionModifier );
		particleSystem2.bindModifier( 'velocity', velocityModifier );
		particleSystem2.bindModifier( 'acceleration', accelerationModifier );
		particleSystem2.bindModifier( 'rotation', rotationModifier );
		particleSystem2.bindModifier( 'rotationalSpeed', rotationalSpeedModifier );

		particleSystems[ ParticleSystemIDs.Smoke1 ] = particleSystem1;	
		particleSystems[ ParticleSystemIDs.Smoke2 ] = particleSystem2;	

	}

	function initializeFlameSystem() {

		// ---------------------
		// flame particle system
		// ---------------------

		var particleSystemParams = {

			particleAtlas : Atlas.createGridAtlas( THREE.ImageUtils.loadTexture( 'images/fireloop3.jpg' ), 0.0, 1.0, 1.0, 0.0, 8.0, 8.0, false, true ),
			
			atlasFrameSet: new Particles.FrameSet( [0, 3], [0, 63], true ),
			sizeFrameSet : new Particles.FrameSet( [ 0, 3], [ new THREE.Vector3( 20, 25 ), new THREE.Vector3( 20, 25 ) ], false ),			
			alphaFrameSet : new Particles.FrameSet( [0, 0.2, 1.2, 2.0, 3], [ 0, .3, 1, 1, 0], true),
			colorFrameSet : new Particles.FrameSet( [0, 3], [ new THREE.Vector3(1.4, 1.4, 1.4), new THREE.Vector3(1.4, 1.4, 1.4) ], false ),
			blendStyle : THREE.AdditiveBlending,  
			
			particleReleaseRate : 3,
			particleLifeSpan : 3,		
			lifespan : 0

		};
		var particleSystem = new Particles.ParticleSystem();
		particleSystem.initialize( camera, particleSystemParams );

		particleSystem.bindModifier( 'position', new Particles.RandomModifier( 
		{ 
			isScalar: false, 
			offset: new THREE.Vector3( 0,  0, 0 ), 
			range: new THREE.Vector3( 0, 0, 0 ), 
			rangeEdgeClamp: false, 
			rangeType: Particles.RangeType.Sphere, 
			runOnce: true
		} ) );

		particleSystem.bindModifier( 'velocity', new Particles.RandomModifier( 
		{ 
			isScalar: false, 
			offset: new THREE.Vector3( 0, 25, 0 ), 
			range: new THREE.Vector3( 10, 2, 10 ), 
			rangeEdgeClamp: false, 
			rangeType: Particles.RangeType.Sphere, 
			runOnce: true
		} ) );

		particleSystems[ ParticleSystemIDs.Flame ] = particleSystem;

		// ---------------------
		// flame embers particle system
		// ---------------------

		particleSystemParams = {

			particleAtlas : new Atlas( THREE.ImageUtils.loadTexture( 'images/Puff.png' ), true ),
			
			atlasFrameSet: new Particles.FrameSet( [0, 3], [0, 0], true ),
			sizeFrameSet : new Particles.FrameSet( [ 0, 3], [ new THREE.Vector3( .35, .35 ), new THREE.Vector3( .35, .35 ) ], false ),			
			alphaFrameSet : new Particles.FrameSet( [0, 0.2, 1.2, 2.0, 3], [ 0, 1, 1, 1, 0], true),
			colorFrameSet : new Particles.FrameSet( [0, 2, 3], [ new THREE.Vector3(1.3, 1.3, 0), new THREE.Vector3(.75, .4, .4), new THREE.Vector3(.6, .6, .6 ) ], false ),
			blendStyle : THREE.AdditiveBlending,  

			particleReleaseRate : 9,
			particleLifeSpan : 3,		
			lifespan : 0

		};
		particleSystem = new Particles.ParticleSystem();
		particleSystem.initialize( camera, particleSystemParams );

		particleSystem.bindModifier( 'position', new Particles.RandomModifier( 
		{ 
			isScalar: false, 
			offset: new THREE.Vector3( 0,  7, 0 ), 
			range: new THREE.Vector3( 3, 0, 3 ), 
			rangeEdgeClamp: false, 
			rangeType: Particles.RangeType.Sphere, 
			runOnce: true
		} ) );

		particleSystem.bindModifier( 'velocity', new Particles.RandomModifier( 
		{ 
			isScalar: false, 
			offset: new THREE.Vector3( 0, 25, 0 ), 
			range: new THREE.Vector3( 15, 25, 15 ), 
			rangeEdgeClamp: true, 
			rangeType: Particles.RangeType.Sphere, 
			runOnce: true
		} ) );

		particleSystem.bindModifier( 'acceleration', new Particles.RandomModifier( 
		{ 
			isScalar: false, 
			offset: new THREE.Vector3( 0, 15, 0 ), 
			range: new THREE.Vector3( 180, 280, 180 ), 
			rangeEdgeClamp: true, 
			rangeType: Particles.RangeType.Sphere, 
			runOnce: false
		} ) );

		particleSystems[ ParticleSystemIDs.FlameEmbers ] = particleSystem;

	}

	function initGUI() {

		gui = new dat.GUI();	
		parameters = 
		{
			smoke:  function() { smokeActive = !smokeActive; updateSmokeType(); },	
			smokeType:  null,					
			embers:  function() { toggleParticleSystem( ParticleSystemIDs.FlameEmbers ); },	
			flame:  function() { toggleParticleSystem( ParticleSystemIDs.Flame ); },	
		};

		gui.add(parameters, 'smokeType', { Basic: ParticleSystemIDs.Smoke1, Animated: ParticleSystemIDs.Smoke2 } ).name( "Smoke type" ).onChange( function () {
			
			smokeType = parameters.smokeType;
			updateSmokeType();

		});
		gui.add( parameters, 'smoke' ).name( "Toggle smoke" );	
		gui.add( parameters, 'embers' ).name( "Toggle embers" );	
		gui.add( parameters, 'flame' ).name( "Toggle flame" );	
		gui.open();

	}

	function initListeners() {

        window.addEventListener( 'resize', onWindowResize, false );
        
    }

	function initRenderer() {

		renderer = new THREE.WebGLRenderer();
        renderer.setSize( screenWidth, screenHeight );
        renderer.setClearColor( 0x000000 );
        renderer.shadowMap.enabled = true;
		renderer.shadowMap.type = THREE.PCFSoftShadowMap;
		rendererContainer = document.getElementById( 'renderingContainer' );
		rendererContainer.appendChild( renderer.domElement );

	}

	function initLights() {

   		ambientLight = new THREE.AmbientLight( 0x101010 );
        scene.add( ambientLight );

		pointLight = new THREE.PointLight( 0xffffff, 2, 1000, 1);
		pointLight.position.set(0,40,0);
		pointLight.castShadow = true;
		pointLight.shadowCameraNear = 1;
		pointLight.shadowCameraFar = 1000;
		pointLight.shadowDarkness = .8;
		// pointLight.shadowCameraVisible = true;
		pointLight.shadowMapWidth = 4096;
		pointLight.shadowMapHeight = 2048;
		pointLight.shadowBias = -0.5;
		scene.add(pointLight);

	}

	function initSceneGeometry( onFinished ) {

		var loadedCount = 0;
		var targetLoadCount = 3;
		var onFinishedCalled = false;

		function incrementAndCheckLoadComplete() {

			loadedCount++;

			if( ! onFinishedCalled && loadedCount >= targetLoadCount && onFinished) {

				onFinishedCalled = true;
				onFinished();
			}

		}

		// ---------------------
        // create ground
        // ---------------------

        var groundTexture = new THREE.ImageUtils.loadTexture( 'images/grass1.jpg' );
        groundTexture.wrapS = THREE.RepeatWrapping; 
        groundTexture.wrapT = THREE.RepeatWrapping; 
        groundTexture.repeat.set( 10, 10 );

        var groundMaterial = new THREE.MeshLambertMaterial( {

                color: 0xffffff,
                shading: THREE.SmoothShading,
                map: groundTexture,
                vertexColors: THREE.NoColors,
                side: THREE.BackSide

        } );

        var groundGeometry = new THREE.PlaneGeometry( 1000, 1000, 30, 30 );
        var groundMesh = new THREE.Mesh( groundGeometry, groundMaterial );
        groundMesh.position.y = 0;
        groundMesh.rotation.x = Math.PI / 2.0;
        groundMesh.receiveShadow = true;
        scene.add(groundMesh);

		// ---------------------
		// load campfire
		// ---------------------
		var campFireMaterial = new THREE.MeshLambertMaterial( {

                color: 0xffffff,
                shading: THREE.SmoothShading,
                vertexColors: THREE.NoColors,
                side: THREE.FrontSide

        } );

		ParticleSystemUtil.loadObj( 'models/CampFire01.obj', 'models/Stuff01.png', campFireMaterial,

			function( mesh ) { mesh.castShadow = true; mesh.receiveShadow = false; }, 
			function( object ) { 

				object.position.set( 0, 0, 0 ); 
				object.scale.set( 7, 7, 7 ); 
				scene.add( object ); 

				incrementAndCheckLoadComplete();
			}

		);

		// ---------------------
		// load rocks
		// ---------------------

		var rockMaterial = new THREE.MeshLambertMaterial( {

                color: 0xffffff,
                shading: THREE.SmoothShading,
                vertexColors: THREE.NoColors,
                side: THREE.FrontSide

        } );

		ParticleSystemUtil.loadObj( 'models/rock01.obj', 'models/Rock01.png', rockMaterial,

			function( mesh ) { mesh.castShadow = true;	mesh.receiveShadow = true; }, 
			function( object ) { 

				object.position.set( -70, 0, 0 ); 
				object.scale.set( .55, .55, .55 ); 
				scene.add( object ); 

				var rockObject2 = object.clone();
				rockObject2.rotation.z = -Math.PI / 4; 
				rockObject2.rotation.x = Math.PI /2; 
				rockObject2.position.set( -55, -1, 25 ); 
				rockObject2.scale.set( .35, .35, .35 ); 
				scene.add( rockObject2 ); 

				var rockObject3 = object.clone();
				rockObject3.rotation.z = Math.PI / 4; 
				rockObject3.rotation.x = Math.PI /2; 
				rockObject3.position.set( 45, 10, 45 ); 
				rockObject3.scale.set( .65, .65, .85 ); 
				scene.add( rockObject3 ); 
				
				incrementAndCheckLoadComplete();

			} 

		);

		// ---------------------
		// load trees
		// ---------------------

		var treeMaterial = new THREE.MeshLambertMaterial( {

                color: 0xffffff,
                shading: THREE.SmoothShading,
                vertexColors: THREE.NoColors,
                side: THREE.FrontSide

        } );

		ParticleSystemUtil.loadObj( 'models/treeplaindouble.obj', 'models/tree-noel1.jpg', treeMaterial,

			function( mesh ) { mesh.castShadow = true;	mesh.receiveShadow = true; }, 
			function( object ) { 

				object.rotation.z = Math.PI / 64; 
				object.rotation.x = Math.PI / 64; 
				object.position.set( -20, -1, -80 ); 
				object.scale.set( 1.155, 1.155, 1.155 ); 
				scene.add( object ); 

				var treeObject2 = object.clone();
				treeObject2.rotation.z = - Math.PI / 16; 
				treeObject2.rotation.x = Math.PI / 32; 
				treeObject2.position.set( 15, -1, -80 ); 
				treeObject2.scale.set( .855, .855, .855 ); 
				scene.add( treeObject2 ); 

				incrementAndCheckLoadComplete();

			} 

		);

	}

	function initScene() {

		scene = new THREE.Scene();

		camera = new THREE.PerspectiveCamera( 45, 1.0, 2, 2000 );
		scene.add(camera);
		resetCamera();
		
	}

	function initStats() {

		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.bottom = '0px';
		stats.domElement.style.zIndex = 100;
		rendererContainer.appendChild( stats.domElement );

	}

	function initControls() {

        controls = new THREE.OrbitControls( camera, renderer.domElement );
        controls.target.set( 0, 0, 0 );
        controls.update();

    }

	function onWindowResize() { 

		renderer.setSize( screenWidth, screenHeight );
		resetCamera();		

	}	

	var flickerPointLight = ( function() {

		var lastAdjuster;

		return function flickerPointLight() {

			var adjuster = (Math.random() - 0.5);

			if( lastAdjuster ) {

				diff = (adjuster - lastAdjuster) *.2;
				adjuster = lastAdjuster + diff;

			}

			var intensity = 4;
			intensity += adjuster * 4;
			pointLight.intensity = intensity;

			pointLight.distance = adjuster * 50 + 200;
			pointLight.decay = adjuster * 5 + 3;

			lastAdjuster = adjuster;
		}

	})();

	function updateSmokeType() {

		particleSystems[ ParticleSystemIDs.Smoke1 ].deactivate();
		particleSystems[ ParticleSystemIDs.Smoke2 ].deactivate();

		if( smokeActive ) {			

			particleSystems[ smokeType ].activate();

		}
	}

	function toggleParticleSystem( id ) {

		if( particleSystems[ id ]) {

			if( particleSystems[ id ].isActive ) {

				particleSystems[ id ].deactivate();

			} else {
				
				particleSystems[ id ].activate();

			}

		}

	}

	function startParticleSystemEnvironment( id ) {

		resetCamera();	

		Object.keys( particleSystems ).forEach( function( key ) {

			var system = particleSystems[ key ];
			system.deactivate();

		});

		currentEnvironmentID = id;
		if( id == ParticleEnvironmentIDs.Campfire ) {
			
			smokeActive = true;
			particleSystems[ ParticleSystemIDs.Flame ].activate();  
			particleSystems[ ParticleSystemIDs.FlameEmbers ].activate();  
			updateSmokeType();
			pointLight.distance = 300;
			pointLight.intensity = 6;
			pointLight.color.setRGB( 1, .8, .4);
			pointLight.decay = 2;
			pointLight.position.set(0,40,0);

			ambientLight.color.setRGB( .08, .08, .08 );

		} else {

			return;
		}

	}

	function getScreenDimensions() {

		screenWidth = window.innerWidth;
		screenHeight = window.innerHeight;

	}

	function resetCamera() {

		getScreenDimensions();
		camera.aspect = screenWidth / screenHeight;
		camera.updateProjectionMatrix();
		camera.position.set(0,200,400);
		camera.lookAt(scene.position);	

	}

	function updateParticleSystems() {

		var deltaTime = clock.getDelta();

		Object.keys( particleSystems ).forEach( function( key ) {

			var system = particleSystems[ key ];
			if ( system.isActive ) {

				system.update( deltaTime );

			}

		});

		if ( currentEnvironmentID == ParticleEnvironmentIDs.Campfire ) {

			flickerPointLight();

		}

	}

	function animate() {

	    requestAnimationFrame( animate );
	    update();
		render();	

	}

	function update() {

		//controls.update();
		stats.update();	
		updateParticleSystems();		

	}

	function render() {

		renderer.render( scene, camera );

	}

</script>
</body>
</html>
